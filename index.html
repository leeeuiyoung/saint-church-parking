<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>외부주차비용 신청서</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js",
            "lucide-react": "https://esm.sh/lucide-react@0.344.0"
        }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-slate-100">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { getFirestore, collection, addDoc, serverTimestamp, doc, getDoc, updateDoc } from 'firebase/firestore';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
        import { Car, User, MapPin, CheckCircle2, AlertCircle, Edit3, Loader2, CalendarDays, Users, Banknote } from 'lucide-react';

        const firebaseConfig = {
            apiKey: "AIzaSyB8mujwEnMA0oynk5liia3QXPMWGQyPRfs",
            authDomain: "hwayangchurch-parking-app.firebaseapp.com",
            projectId: "hwayangchurch-parking-app",
            storageBucket: "hwayangchurch-parking-app.appspot.com",
            messagingSenderId: "104913357347",
            appId: "1:104913357347:web:e3054f97d1d63b97cf7f96"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // [수정됨] 목사님의 깃헙 이름과 통일했습니다.
        const appId = 'saint-church-parking';

        const PARKING_LOCATIONS = ["어린이회관 주차장1", "어린이회관 주차장2", "세종대 대양AI센터 주차장", "국민은행 주차장", "교회 뒷편 세종대 주차장", "광진광장 공영주차장"];
        const POSITIONS = ["청년", "성도", "집사", "권사", "장로"]; 
        const BANK_NAMES = ["카카오뱅크", "국민", "농협", "신한", "우리", "하나", "기업", "토스뱅크", "새마을", "우체국", "SC제일", "대구", "부산", "광주", "신협", "수협"].sort();

        function MemberApp() {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [submitting, setSubmitting] = useState(false);
            const [docId, setDocId] = useState(null);
            const [complete, setComplete] = useState(false);

            const [formData, setFormData] = useState({
                parkingDate: new Date().toISOString().split('T')[0],
                name: '',
                position: '성도',
                carNumber: '',
                parkingLocation: PARKING_LOCATIONS[0],
                bankName: BANK_NAMES[0],
                accountNumber: '',
                phoneNumber: '' 
            });

            useEffect(() => {
                signInAnonymously(auth).catch((error) => console.error("Login Error:", error));
                const unsub = onAuthStateChanged(auth, (u) => {
                    if (u) {
                        setUser(u);
                        loadSavedData(u.uid);
                    }
                });
                return () => unsub();
            }, []);

            const loadSavedData = async (uid) => {
                try {
                    let isEditingToday = false;
                    const today = new Date().toISOString().split('T')[0];
                    const savedDocId = localStorage.getItem('my_parking_id');

                    if (savedDocId) {
                        const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'parkingRecords', savedDocId);
                        const docSnap = await getDoc(docRef);
                        if (docSnap.exists()) {
                            const data = docSnap.data();
                            const recordDate = data.parkingDate || today;
                            if (recordDate === today) {
                                setDocId(savedDocId);
                                isEditingToday = true;
                                
                                let bankName = BANK_NAMES[0];
                                let accountNumber = '';
                                if (data.accountInfo) {
                                    const separator = data.accountInfo.includes('/') ? '/' : ' ';
                                    const parts = data.accountInfo.split(separator);
                                    if (parts.length > 1) {
                                        bankName = parts[0];
                                        accountNumber = parts.slice(1).join('');
                                    } else {
                                        accountNumber = data.accountInfo;
                                    }
                                }

                                setFormData({
                                    parkingDate: data.parkingDate || today,
                                    name: data.name || '',
                                    position: data.position || '성도',
                                    carNumber: data.carNumber || '',
                                    parkingLocation: data.parkingLocation || PARKING_LOCATIONS[0],
                                    bankName: bankName,
                                    accountNumber: accountNumber,
                                    phoneNumber: data.phoneNumber || ''
                                });
                            } else { localStorage.removeItem('my_parking_id'); }
                        }
                    }

                    if (!isEditingToday) {
                        const savedProfile = localStorage.getItem('church_parking_profile');
                        if (savedProfile) {
                            const profile = JSON.parse(savedProfile);
                            setFormData(prev => ({ ...prev, ...profile, parkingDate: today }));
                        }
                    }
                } catch (e) { console.error(e); }
                setLoading(false);
            };

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!user) { alert("잠시 후 다시 시도해주세요 (인증 중)"); return; }
                setSubmitting(true);

                const payload = {
                    parkingDate: formData.parkingDate,
                    name: formData.name,
                    position: formData.position,
                    carNumber: formData.carNumber,
                    parkingLocation: formData.parkingLocation,
                    accountInfo: `${formData.bankName}/${formData.accountNumber}`, 
                    phoneNumber: formData.phoneNumber,
                    updatedAt: serverTimestamp(),
                    userId: user.uid,
                    calculatedFee: 0, parkingDurationHours: 0, hourlyRate: 0, isSelfRegistered: true
                };

                try {
                    if (docId) {
                        const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'parkingRecords', docId);
                        await updateDoc(docRef, payload);
                    } else {
                        payload.createdAt = serverTimestamp();
                        const docRef = await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'parkingRecords'), payload);
                        localStorage.setItem('my_parking_id', docRef.id);
                        setDocId(docRef.id);
                    }
                    
                    const profile = { ...formData };
                    localStorage.setItem('church_parking_profile', JSON.stringify(profile));
                    setComplete(true);
                } catch (error) {
                    console.error(error);
                    if (error.code === 'permission-denied') {
                        alert("⚠️ 저장 실패! (권한 오류)\n\n목사님, 파이어베이스 콘솔에서 [Firestore Database] -> [규칙(Rules)] 탭에 들어가셔서 코드를 수정하고 [게시] 버튼을 눌러주셔야 합니다.");
                    } else {
                        alert("저장 실패: " + error.message);
                    }
                } finally {
                    setSubmitting(false);
                }
            };

            if (loading) return <div className="min-h-screen flex items-center justify-center bg-slate-50"><Loader2 className="animate-spin text-blue-600 w-10 h-10"/></div>;

            if (complete) {
                return (
                    <div className="min-h-screen bg-slate-50 flex flex-col items-center justify-center p-6 text-center animate-in fade-in zoom-in duration-500">
                        <div className="bg-white p-8 rounded-[2rem] shadow-xl w-full max-w-md border-2 border-green-100">
                            <div className="w-20 h-20 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-6 shadow-inner">
                                <CheckCircle2 size={40} />
                            </div>
                            <h2 className="text-2xl font-black text-slate-800 mb-2">신청이 완료되었습니다!</h2>
                            <p className="text-slate-500 font-bold mb-8">안전하게 귀가하세요.</p>
                            <div className="bg-slate-50 rounded-2xl p-6 text-left mb-6 border border-slate-100 space-y-2">
                                <p className="text-xs font-black text-slate-400 uppercase mb-2 pb-2 border-b border-slate-200">신청 정보 확인</p>
                                <div className="flex justify-between"><span className="text-slate-500">신청자</span><span className="font-black text-slate-800">{formData.name} ({formData.position})</span></div>
                                <div className="flex justify-between"><span className="text-slate-500">날짜</span><span className="font-bold text-slate-800">{formData.parkingDate}</span></div>
                                <div className="flex justify-between"><span className="text-slate-500">차량번호</span><span className="font-black text-blue-600">{formData.carNumber}</span></div>
                                <div className="text-right text-sm text-slate-400 mt-2">{formData.parkingLocation}</div>
                            </div>
                            <button onClick={() => setComplete(false)} className="w-full py-4 bg-slate-800 text-white rounded-2xl font-black text-lg shadow-lg active:scale-95 transition-all flex items-center justify-center gap-2">
                                <Edit3 size={18} /> 내용 수정하기
                            </button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-slate-100 font-sans p-4 flex flex-col items-center justify-center">
                    <div className="w-full max-w-md bg-white rounded-[2rem] shadow-2xl overflow-hidden border border-slate-200">
                        <div className="bg-blue-600 p-8 text-center relative overflow-hidden">
                             <div className="absolute top-0 left-0 w-full h-full bg-white opacity-10" style={{backgroundImage: 'radial-gradient(circle, #000 1px, transparent 1px)', backgroundSize: '20px 20px'}}></div>
                            <h1 className="text-2xl font-black text-white relative z-10 flex items-center justify-center gap-2">
                                <Car className="w-8 h-8"/> 차량정보를 입력해 주세요
                            </h1>
                        </div>
                        <form onSubmit={handleSubmit} className="p-8 space-y-6">
                            {docId && (
                                <div className="bg-orange-50 text-orange-600 p-4 rounded-2xl text-sm font-bold flex items-center gap-2 border border-orange-100">
                                    <AlertCircle size={16}/> 기존 신청 내역을 수정 중입니다.
                                </div>
                            )}
                            <div className="space-y-2">
                                <label className="text-sm font-black text-slate-500 ml-1 uppercase flex items-center gap-2"><CalendarDays size={14}/> 주차 날짜</label>
                                <input type="date" name="parkingDate" value={formData.parkingDate} onChange={handleChange} className="w-full p-4 bg-slate-50 border-2 border-slate-200 rounded-2xl font-bold text-lg focus:outline-none focus:border-blue-500 focus:bg-white transition-colors" required />
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <div className="space-y-2">
                                    <label className="text-sm font-black text-slate-500 ml-1 uppercase flex items-center gap-2"><User size={14}/> 성함</label>
                                    <input type="text" name="name" value={formData.name} onChange={handleChange} placeholder="성함" className="w-full p-4 bg-slate-50 border-2 border-slate-200 rounded-2xl font-bold text-lg focus:outline-none focus:border-blue-500 focus:bg-white transition-colors" required />
                                </div>
                                <div className="space-y-2">
                                    <label className="text-sm font-black text-slate-500 ml-1 uppercase flex items-center gap-2"><Users size={14}/> 직분</label>
                                    <select name="position" value={formData.position} onChange={handleChange} className="w-full p-4 bg-slate-50 border-2 border-slate-200 rounded-2xl font-bold text-lg focus:outline-none focus:border-blue-500 focus:bg-white transition-colors appearance-none">
                                        {POSITIONS.map(p => <option key={p} value={p}>{p}</option>)}
                                    </select>
                                </div>
                            </div>
                            <div className="space-y-2">
                                <label className="text-sm font-black text-slate-500 ml-1 uppercase flex items-center gap-2"><Banknote size={14}/> 환급 계좌 (본인 명의)</label>
                                <div className="flex gap-2">
                                    <select name="bankName" value={formData.bankName} onChange={handleChange} className="w-1/3 p-4 bg-slate-50 border-2 border-slate-200 rounded-2xl font-bold text-lg focus:outline-none focus:border-blue-500 focus:bg-white transition-colors appearance-none">
                                        {BANK_NAMES.map(bank => <option key={bank} value={bank}>{bank}</option>)}
                                    </select>
                                    <input type="text" name="accountNumber" value={formData.accountNumber} onChange={(e) => setFormData(prev => ({...prev, accountNumber: e.target.value.replace(/[^0-9]/g, '')}))} placeholder="계좌번호 (숫자만)" className="flex-1 p-4 bg-slate-50 border-2 border-slate-200 rounded-2xl font-bold text-lg focus:outline-none focus:border-blue-500 focus:bg-white transition-colors" required />
                                </div>
                            </div>
                            <div className="space-y-2">
                                <label className="text-sm font-black text-slate-500 ml-1 uppercase flex items-center gap-2"><Car size={14}/> 차량 번호 (전체)</label>
                                <input type="text" name="carNumber" value={formData.carNumber} onChange={handleChange} placeholder="예: 12가 3456" className="w-full p-4 bg-slate-50 border-2 border-slate-200 rounded-2xl font-bold text-lg focus:outline-none focus:border-blue-500 focus:bg-white transition-colors" required />
                            </div>
                            <div className="space-y-2">
                                <label className="text-sm font-black text-slate-500 ml-1 uppercase flex items-center gap-2"><MapPin size={14}/> 주차 장소</label>
                                <select name="parkingLocation" value={formData.parkingLocation} onChange={handleChange} className="w-full p-4 bg-slate-50 border-2 border-slate-200 rounded-2xl font-bold text-lg focus:outline-none focus:border-blue-500 focus:bg-white transition-colors appearance-none">
                                    {PARKING_LOCATIONS.map(loc => <option key={loc} value={loc}>{loc}</option>)}
                                </select>
                            </div>
                            <div className="pt-2">
                                <div className="bg-red-50 text-red-600 p-3 rounded-xl text-xs font-black text-center mb-4">
                                    * 주차비용 정산은 등록교인만 가능합니다.
                                </div>
                                <button type="submit" disabled={submitting} className="w-full py-5 bg-blue-600 text-white font-black text-xl rounded-2xl shadow-xl shadow-blue-200 hover:bg-blue-700 active:scale-95 transition-all flex items-center justify-center">
                                    {submitting ? <Loader2 className="animate-spin"/> : (docId ? '신청서 수정하기' : '비용 신청하기')}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<MemberApp />);
    </script>
</body>
</html>
